<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Microbiology Study Hub</title>

  <!-- Google Font: Lexend -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    /* ===== Theme ===== */
    :root {
      --g1: #60a5fa;
      --g2: #a78bfa;
      --g3: #34d399;
      --bg: #0b1020;
      --panel: #0f1b31;
      --panel2: #0e1830;
      --tile: #101d35;
      --tile2: #0f1a32;
      --line: #22314d;
      --ink-100: #eef5ff;
      --ink-700: #c7d6ff;
      --ink-800: #9fb1d1;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 24px 72px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .03);
    }

    * {
      box-sizing: border-box
    }

    html {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh; /* Ensures body is at least full viewport height */
      font-family: "Lexend", system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--ink-800);
      background: #0a1120;
      background:
        radial-gradient(1100px 600px at 20% -10%, rgba(96, 165, 250, .14), transparent),
        radial-gradient(900px 520px at 90% -20%, rgba(167, 139, 250, .18), transparent),
        linear-gradient(180deg, #0b1220, #0a1120 30%, #09101f 70%, #0a1120);
      background-attachment: fixed; /* Fixes the "chopped" background issue */
    }
    
    button, input, textarea {
        font-family: inherit;
    }

    body::before {
      content: "";
      position: fixed;
      inset: -20%;
      z-index: -1;
      background:
        radial-gradient(60rem 40rem at 12% 15%, rgba(96, 165, 250, .22), transparent 60%),
        radial-gradient(60rem 40rem at 88% 12%, rgba(167, 139, 250, .18), transparent 60%),
        radial-gradient(70rem 50rem at 30% 88%, rgba(52, 211, 153, .18), transparent 60%);
      filter: blur(70px) saturate(110%);
      opacity: .6;
      animation: shift 60s ease-in-out infinite alternate;
    }

    @keyframes shift {
      0% {
        transform: translateX(-1%)
      }

      100% {
        transform: translateX(1%)
      }
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column; /* Allows content to grow naturally */
      padding: 32px 16px; /* Add padding to the page container */
    }

    .shell {
      width: 100%; /* Make shell take full width of its parent */
      max-width: 1200px; /* But cap it at 1200px */
      margin: 0 auto; /* Center the shell horizontally */
      padding: 24px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      opacity: 0; /* Initially hidden for splash screen */
      transition: opacity 0.5s ease-in-out;
    }
    .shell.loaded {
        opacity: 1;
    }
    
    .header-container, section, .modal-card {
        position: relative;
        z-index: 1;
    }


    /* ===== Header Layout ===== */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
        flex-grow: 1; /* Allow left side to grow */
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0; /* Prevent controls from shrinking */
    }
    
    .brand {
      color: var(--ink-100);
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: .2px;
    }

    /* ===== Nav / Tabs ===== */
    .tabs {
      display: flex;
      gap: 8px;
      background: linear-gradient(180deg, var(--tile), var(--tile2));
      border: 1px solid var(--line);
      padding: 8px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
    }

    .tab {
      border: 1px solid transparent;
      background: transparent;
      color: var(--ink-800);
      font-weight: 700;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover {
      color: var(--ink-100);
      border-color: #35507e;
      background: rgba(255, 255, 255, .04)
    }

    .tab.active {
      color: var(--ink-100);
      border-color: #35507e;
      background: rgba(255, 255, 255, .06)
    }
    
    /* ===== Toggle Switch ===== */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #334155;
        transition: .4s;
        border-radius: 28px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background: linear-gradient(90deg, var(--g1), var(--g2));
    }
    input:checked + .slider:before {
        transform: translateX(22px);
    }


    /* ===== Lists / Rows ===== */
    .list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 2px
    }

    .row {
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      cursor: pointer;
      background: linear-gradient(180deg, var(--tile), var(--tile2));
      color: var(--ink-100);
      transition: transform .08s ease, border-color .15s ease, box-shadow .15s ease;
      box-shadow: var(--shadow);
    }

    .row:hover {
      transform: translateY(-1px);
      border-color: #35507e
    }

    .left {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .right {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #9fb1d1
    }

    .icon {
      width: 18px;
      height: 18px;
      color: #a6b8e0
    }

    .row:focus,
    .row:focus-visible {
      outline: none;
      box-shadow: none
    }

    .row::before {
      content: none !important;
    }

    /* ===== Crumbs ===== */
    .crumbs {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0 12px;
      flex-wrap: wrap;
    }

    .crumb {
      border: 1px solid var(--line);
      background: transparent;
      color: var(--ink-800);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer
    }
    .crumb.disabled {
        pointer-events: none;
        opacity: 0.5;
    }

    .crumb:hover {
      color: var(--ink-100);
      border-color: #35507e
    }

    .crumb.active {
      color: var(--ink-100);
      border-color: #35507e;
      cursor: default
    }

    .sep {
      opacity: .6
    }

    /* ===== Pills / Mini ===== */
    .pill {
      font-size: .8rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .pill.ok {
      color: #a7f3d0;
      border-color: rgba(16, 185, 129, .45);
      background: rgba(16, 185, 129, .12)
    }

    .pill.warn {
      color: #c9a65e;
      border-color: rgba(245, 158, 11, .35);
      background: rgba(249, 201, 115, .08)
    }

    .mini {
      font-weight: 700;
      font-size: .9rem;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .03);
      color: var(--ink-800);
      cursor: pointer
    }

    .mini:hover {
      border-color: #35507e;
      color: var(--ink-100)
    }

    .mini.ghost {
      background: transparent
    }

    /* ===== Stats / Grid ===== */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Make stats responsive */
      gap: 12px;
      margin: 8px 0 14px
    }

    .stat-card {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      text-align: center
    }

    .stat-k {
      color: #8fb1eb;
      font-size: .9rem;
      font-weight: 700
    }

    .stat-v {
      color: var(--ink-100);
      font-size: 1.35rem;
      font-weight: 800
    }

    .subject-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .subject-card {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: linear-gradient(180deg, var(--tile), var(--tile2));
      box-shadow: var(--shadow)
    }

    .sub-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 8px;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, .05)
    }

    .sub-title {
      color: var(--ink-100);
      font-weight: 800
    }

    .sub-meta {
      color: var(--ink-800)
    }

    .meter {
      height: 8px;
      border-radius: 999px;
      background: #0b1a34;
      border: 1px solid #1e2c49;
      overflow: hidden;
      margin-bottom: 10px
    }

    .meter-fill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--g1), var(--g2), var(--g3));
      transition: width .35s ease
    }

    /* Emoji chips for sets */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px
    }

    .chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, .03);
      color: var(--ink-100);
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px
    }

    .chip:hover {
      border-color: #35507e
    }

    .chip-ok {
      background: rgba(16, 185, 129, .10);
      border-color: rgba(16, 185, 129, .45)
    }

    .chip-warn {
      background: rgba(245, 158, 11, .08);
      border-color: rgba(245, 158, 11, .35)
    }

    .chip .reset {
      margin-left: 6px;
      border: 1px solid var(--line);
      background: transparent;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: .85rem;
      color: #cdd9f0
    }

    .chip .reset:hover {
      border-color: #35507e;
      color: #fff
    }

    /* ===== Polished Quiz Panel ===== */
    #quizPanel {
        padding: 24px;
        border: 1px solid var(--line);
        border-radius: 16px;
        background: linear-gradient(165deg, var(--panel), var(--panel2));
        box-shadow: var(--shadow);
    }
    .meter.big {
        height: 12px;
        margin-top: 16px;
        margin-bottom: 20px;
    }
    .question {
        color: var(--ink-100);
        font-weight: 700;
        font-size: 1.4rem;
        line-height: 1.4;
        margin-bottom: 24px;
    }
    .opts {
      display: grid;
      gap: 12px;
      margin-bottom: 24px;
    }

    .opt {
      width: 100%;
      text-align: left;
      color: var(--ink-700);
      background: linear-gradient(180deg, var(--tile), var(--tile2));
      border: 1px solid var(--line);
      padding: 14px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 500;
      transition: all .2s ease;
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.03);
    }

    .opt:not(:disabled):hover {
      border-color: #4a6591;
      color: var(--ink-100);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.05);
    }
    
    .opt:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }

    .opt.correct {
      border-color: rgba(16, 185, 129, .7);
      background: rgba(16, 185, 129, .15);
      color: #fff;
      box-shadow: 0 0 20px rgba(16, 185, 129, .2);
    }

    .opt.incorrect {
      border-color: rgba(239, 68, 68, .7);
      background: rgba(239, 68, 68, .15);
      color: #ffdddd;
      box-shadow: 0 0 20px rgba(239, 68, 68, .2);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      justify-content: flex-end; /* Pushes buttons to the right */
      align-items: center;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .03);
      color: var(--ink-100);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn:not(:disabled):hover {
        background: rgba(255,255,255, .08);
        border-color: #4a6591;
        transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed
    }

    .btn.ghost {
      background: transparent
    }
    
    .btn.primary {
        background: var(--g1);
        border-color: transparent;
        color: white;
        box-shadow: 0 4px 15px rgba(96, 165, 250, 0.2);
    }
    .btn.primary:hover:not(:disabled) {
        background: #79b6fa;
        box-shadow: 0 6px 20px rgba(96, 165, 250, 0.3);
    }

    .btn.danger {
        background: rgba(239, 68, 68, .12);
        border-color: rgba(239, 68, 68, .45);
        color: #ffd6d6;
    }
    .btn.danger:hover {
        background: rgba(239, 68, 68, .25);
        border-color: rgba(239, 68, 68, .6);
        color: #fff;
    }


    /* ===== Improved History View ===== */
    .history-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .hist-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--tile), var(--tile2));
      border: 1px solid var(--line);
    }
    .hist-row.header {
      background: transparent;
      border: none;
      color: var(--ink-800);
      font-weight: 700;
      padding-bottom: 8px;
    }
    .hist-q-cell {
      flex: 1;
      color: var(--ink-100);
      font-weight: 500;
      padding-right: 16px;
    }
    .hist-meta-cell {
      width: 240px; /* Increased width */
      flex-shrink: 0;
      text-align: left;
      color: var(--ink-800);
    }
    .hist-action-cell {
      width: 120px;
      flex-shrink: 0;
      text-align: right;
    }

    .hist-empty {
      text-align: center;
      color: #88a1cc;
      padding: 16px 0;
      border: 1px dashed var(--line);
      border-radius: 12px;
      background: rgba(255, 255, 255, .02)
    }

    /* ===== Modal & Toast ===== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 80px;
      z-index: 999;
      backdrop-filter: blur(4px);
    }

    .modal.hidden {
      display: none
    }

    .modal-card {
      width: min(720px, 92vw);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: 0 25px 80px rgba(0, 0, 0, .55)
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px
    }
    .spacer {
        flex-grow: 1;
    }

    .rev-meta {
      color: #9fb1d1
    }

    .review-question {
      color: var(--ink-100);
      font-weight: 800;
      margin-bottom: 8px
    }

    .review-answers {
      display: flex;
      flex-wrap: wrap;
      gap: 8px
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      z-index: 1000;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, .06);
      color: var(--ink-100);
      font-weight: 700
    }

    .toast.hidden {
      display: none
    }

    /* ===== Settings View ===== */
    #settingsView {
        padding: 16px;
    }
    .setting-group {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: linear-gradient(180deg, var(--tile), var(--tile2));
        margin-bottom: 12px;
        overflow: hidden;
    }
    .setting-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        cursor: pointer;
    }
     .setting-group-header .title {
        color: var(--ink-100);
        font-weight: 700;
        font-size: 1.1rem;
    }
    .setting-group-header .desc {
        color: var(--ink-800);
        font-size: 0.9rem;
        margin-top: 4px;
    }
    .setting-group-header .chevron {
        transition: transform 0.3s ease;
    }
    .setting-group-header.open .chevron {
        transform: rotate(90deg);
    }
    .setting-group-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        background: rgba(0,0,0,0.15);
    }
    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-top: 1px solid var(--line);
        flex-wrap: wrap;
        gap: 12px;
    }
    .setting-text .title {
        color: var(--ink-100);
        font-weight: 700;
        font-size: 1.05rem;
    }
    .setting-text .desc {
        color: var(--ink-800);
        font-size: 0.9rem;
        margin-top: 4px;
    }
    .setting-control {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--ink-100);
        font-weight: 500;
    }
    .setting-control input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 120px;
        height: 6px;
        background: #22314d;
        border-radius: 5px;
        outline: none;
    }
    .setting-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: var(--ink-100);
        cursor: pointer;
        border-radius: 50%;
    }
    .setting-control input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: var(--ink-100);
        cursor: pointer;
        border-radius: 50%;
    }

    /* ===== Subjective Question UI ===== */
    #subjectivePanel {
        margin-bottom: 24px;
    }
    #subjectiveAnswerInput {
        width: 100%;
        min-height: 120px;
        background: var(--tile2);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        color: var(--ink-100);
        font-size: 1rem;
        resize: vertical;
    }
    #subjectiveAnswerInput:focus {
        outline: none;
        border-color: var(--g1);
        box-shadow: 0 0 15px rgba(96, 165, 250, 0.2);
    }
    #revealedAnswerPanel {
        margin-top: 16px;
        padding: 16px;
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--line);
        border-radius: 12px;
    }
    #revealedAnswerPanel .answer-title {
        font-weight: 700;
        color: var(--ink-800);
        margin-bottom: 8px;
    }
    #revealedAnswerPanel .answer-text {
        color: var(--ink-100);
        line-height: 1.5;
    }
    #selfAssessPanel {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }
    #selfAssessPanel .btn {
        flex-grow: 1;
    }
    #selfAssessPanel .btn.correct {
        background-color: rgba(16, 185, 129, .15);
        border-color: rgba(16, 185, 129, .45);
    }
     #selfAssessPanel .btn.incorrect {
        background-color: rgba(239, 68, 68, .15);
        border-color: rgba(239, 68, 68, .45);
    }
    .subjective-btn-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
    }

    /* ===== Splash & Results Screens ===== */
    #splashScreen, #resultsScreen {
        position: fixed;
        inset: 0;
        background: var(--bg);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease-out;
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
        background-color: rgba(11, 16, 32, 0.7);
    }
    #splashScreen img {
        max-width: 90%;
        max-height: 80vh;
        width: 600px;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .tribute-text-container {
        text-align: center;
        margin-top: 24px;
    }
    .tribute-text {
        color: var(--ink-100);
        font-size: 2rem;
        font-weight: 800;
        text-shadow: 0 0 15px rgba(255,255,255,0.3);
        margin-bottom: 8px;
    }
    .tribute-subtext {
        color: var(--ink-100);
        font-size: 1.2rem;
        font-weight: 800;
        text-shadow: 0 0 15px rgba(255,255,255,0.3);
    }
    .splash-fade-out {
        opacity: 0;
        pointer-events: none;
    }
    #resultsCard {
        background: linear-gradient(165deg, var(--panel), var(--panel2));
        border: 1px solid var(--line);
        border-radius: 24px;
        padding: 40px;
        text-align: center;
        box-shadow: var(--shadow);
        width: min(600px, 90vw);
        cursor: pointer;
        transform: scale(0.95);
        opacity: 0;
        animation: result-fade-in 0.5s ease-out forwards;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
    #resultsCard:hover {
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(96, 165, 250, 0.4), var(--shadow);
        border-color: var(--g1);
    }
    #resultsCard::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: rotate(25deg);
        animation: shiny-effect 3s ease-in-out infinite;
        pointer-events: none;
    }
    @keyframes shiny-effect {
        0% { transform: translateX(-75%) rotate(25deg); }
        50% { transform: translateX(75%) rotate(25deg); }
        100% { transform: translateX(-75%) rotate(25deg); }
    }
    @keyframes result-fade-in {
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    #resultsEmoji {
        font-size: 4rem;
        margin-bottom: 16px;
    }
    #resultsTitle {
        color: var(--ink-100);
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 8px;
    }
    #resultsScore {
        color: var(--ink-700);
        font-size: 1.5rem;
        font-weight: 500;
        margin-bottom: 16px;
    }
    #resultsMessage {
        color: var(--ink-800);
        font-size: 1.1rem;
        line-height: 1.6;
    }


    /* ===== Utilities & Mobile Responsiveness ===== */
    .hidden {
      display: none !important;
    }

    /* --- Tablet & Small Desktop (640px and up) --- */
    @media (min-width: 640px) {
        .list, .subject-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* --- Medium Desktop (960px and up) --- */
    @media (min-width: 960px) {
        .opts {
            grid-template-columns: repeat(2, 1fr); /* 2 columns for quiz options on wider screens */
        }
    }

    /* --- Large Desktop (1024px and up) --- */
    @media (min-width: 1024px) {
        .list, .subject-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }


    /* --- Mobile styles (up to 960px) --- */
    @media (max-width: 960px) {
        .page {
            padding: 16px 8px; /* Reduce padding on mobile */
        }
        .header-left {
            width: 100%;
            justify-content: center;
        }
        .header-controls {
            width: 100%;
            justify-content: center;
        }
        .brand {
          font-size: 1.3rem;
          text-align: center;
          width: 100%;
        }
        .tabs {
          justify-content: center;
        }
    }
    
  </style>
</head>

<body>
  <!-- Splash Screen -->
  <div id="splashScreen">
    <img src="Meg.gif" alt="Tribute Animation" onerror="this.onerror=null;this.src='https://placehold.co/600x338/0b1020/eef5ff?text=Megumin!';" >
    <div class="tribute-text-container">
        <div class="tribute-text">Tribute to Hanz Kairo</div>
        <div class="tribute-subtext">For his legendary contribution creating this quiz</div>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="resultsScreen" class="hidden">
      <div id="resultsCard">
          <div id="resultsEmoji"></div>
          <div id="resultsTitle"></div>
          <div id="resultsScore"></div>
          <div id="resultsMessage"></div>
      </div>
  </div>

  <!-- START: AUDIO ELEMENTS FOR SOUND EFFECTS -->
  <audio id="sound-navigate" src="undertale-select-sound_4WQ7oPFx.mp3" preload="auto"></audio>
  <audio id="sound-correct" src="Correct.mp3" preload="auto"></audio>
  <audio id="sound-incorrect" src="Incorrect.mp3" preload="auto"></audio>
  <audio id="sound-finish-good" src="WIN.mp3" preload="auto"></audio>
  <audio id="sound-finish-bad" src="Game Over.mp3" preload="auto"></audio>
  <audio id="sound-background-chill" src="Chill & Relaxing Pokémon Music Mix [YMEblRM4pGc].mp3" loop preload="auto"></audio>
  <audio id="sound-background-hype" src="My Top Ten BEST Undertale Soundtracks.mp3" loop preload="auto"></audio>
  <!-- END: AUDIO ELEMENTS FOR SOUND EFFECTS -->

  <div class="page">
    <div class="shell">
      <div class="header-container">
        <div class="header-left">
            <div class="brand">Microbiology Study Hub</div>
            <div id="tabs" class="tabs">
                <button class="tab active" data-tab="subjects">📚 Subjects</button>
                <button class="tab" data-tab="customQuiz">🔀 Custom Quiz</button>
                <button class="tab" data-tab="qbank">🏦 Question Bank</button>
                <button class="tab" data-tab="progress">📊 Progress</button>
                <button class="tab" data-tab="history">⌛ History</button>
                <button class="tab" data-tab="tutorials">📖 Tutorials</button>
                <button class="tab" data-tab="settings">⚙️ Settings</button>
            </div>
        </div>
        <div class="header-controls">
            <button id="toggleMusicBtn" class="btn ghost"></button>
            <button id="resetAll" class="btn danger">🧹 Reset All</button>
        </div>
      </div>

      <!-- SUBJECTS -->
      <section id="subjectsView"></section>

      <!-- CUSTOM QUIZ -->
      <section id="customQuizView" class="hidden"></section>

      <!-- QUESTION BANK -->
      <section id="qbankView" class="hidden"></section>
      
      <!-- PROGRESS -->
      <section id="progressView" class="hidden"></section>

      <!-- WRONG HISTORY -->
      <section id="historyView" class="hidden"></section>
      
      <!-- TUTORIALS -->
      <section id="tutorialsView" class="hidden"></section>

      <!-- SETTINGS -->
      <section id="settingsView" class="hidden"></section>

      <!-- QUIZ PANEL -->
      <section id="quizPanel" class="hidden">
        <div id="crumbs" class="crumbs"></div>
        <div class="meter big">
          <div id="progFill" class="meter-fill"></div>
        </div>
        <div id="qtext" class="question">Q?. …</div>
        
        <!-- MCQ Options -->
        <div id="opts" class="opts"></div>

        <!-- Subjective Question Area -->
        <div id="subjectivePanel" class="hidden">
            <textarea id="subjectiveAnswerInput" placeholder="Type your answer here..."></textarea>
            <div id="revealedAnswerPanel" class="hidden">
                <div class="answer-title">Correct Answer</div>
                <div id="answerText" class="answer-text"></div>
            </div>
            <div id="selfAssessPanel" class="hidden">
                <button id="btnCorrect" class="btn correct">I was Correct</button>
                <button id="btnIncorrect" class="btn incorrect">I was Incorrect</button>
            </div>
            <div class="subjective-btn-row">
                <button id="btnSkip" class="btn ghost">Skip Question</button>
                <button id="btnReveal" class="btn primary">Reveal Answer</button>
            </div>
        </div>

        <!-- Main Navigation Buttons -->
        <div class="btn-row">
          <button id="btnNext" class="btn">Next</button>
          <button id="btnFinish" class="btn primary hidden">Finish</button>
        </div>
      </section>
    </div>

    <!-- Modal for practice (Wrong History) -->
    <div id="modal" class="modal hidden" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div id="revMeta" class="rev-meta"></div>
          <div class="spacer"></div>
          <button id="closeModal" class="mini ghost">✖</button>
        </div>
        <div id="revQ" class="review-question"></div>
        <div id="revAns" class="review-answers"></div>
        <div class="btn-row">
          <button id="histPrev" class="btn">Prev</button>
          <button id="histNext" class="btn">Next</button>
          <button id="openHistory" class="btn ghost">Back to list</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden"></div>
  </div>

  <script>
    /* ==============================
       Microbiology Study Hub — JS
       (Full file)
       ============================== */

    /* ---------- Utilities ---------- */
    const $ = (s, el = document) => el.querySelector(s);
    const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));

    function shuffleArray(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function toast(msg) {
      const t = $("#toast");
      if (!t) return;
      t.textContent = msg;
      t.classList.remove("hidden");
      setTimeout(() => t.classList.add("hidden"), 3000); // Changed to 3 seconds
    }

    /* ---------- Local Storage State ---------- */
    const PROGRESS_KEY = "studyhub_progress_v3";
    const SETTINGS_KEY = "studyhub_settings_v7"; // Incremented version for new settings

    const S_Progress = () => {
      try {
        return JSON.parse(localStorage.getItem(PROGRESS_KEY)) || {}
      } catch { return {} }
    }
    const W_Progress = s => localStorage.setItem(PROGRESS_KEY, JSON.stringify(s));
    
    const S_Settings = () => {
        try {
            const defaults = { 
                randomizeSetSelection: false, 
                randomizeQuestionOrder: true,
                shuffleAnswerOrder: true,
                excludeSeenQuestions: false,
                randomizeAll: false,
                defaultSetQuestions: 5,
                defaultRandomQuestions: 10,
                showTribute: true,
                soundEffects: true,
                backgroundMusic: true,
                backgroundMusicTrack: 'chill',
                backgroundMusicVolume: 0.3,
                correctVolume: 1.0,
                incorrectVolume: 1.0,
                navigateVolume: 1.0,
                finishGoodVolume: 1.0,
                finishBadVolume: 1.0,
                musicMuted: false
            };
            const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
            return { ...defaults, ...saved };
        } catch { 
            return { 
                randomizeSetSelection: false, 
                randomizeQuestionOrder: true,
                shuffleAnswerOrder: true,
                excludeSeenQuestions: false,
                randomizeAll: false,
                defaultSetQuestions: 5,
                defaultRandomQuestions: 10,
                showTribute: true,
                soundEffects: true,
                backgroundMusic: true,
                backgroundMusicTrack: 'chill',
                backgroundMusicVolume: 0.3,
                correctVolume: 1.0,
                incorrectVolume: 1.0,
                navigateVolume: 1.0,
                finishGoodVolume: 1.0,
                finishBadVolume: 1.0,
                musicMuted: false
            } 
        }
    }
    const W_Settings = s => localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));

    const getSet = (k, i) => S_Progress() ?.[k] ?.[i];
    const putSet = (k, i, val) => {
      const s = S_Progress();
      if (!s[k]) s[k] = {};
      s[k][i] = val;
      W_Progress(s)
    }
    const resetSet = (k, i) => {
      const s = S_Progress();
      if (s ?.[k] ?.[i]) {
        delete s[k][i];
        W_Progress(s)
      }
    }
    const addWrong = (k, i, qid) => {
      const s = S_Progress();
      (s.__history ??= []).push({ k, i, qid, ts: Date.now() });
      W_Progress(s)
    }
    const remWrong = (k, i, qid) => {
      const s = S_Progress();
      if (!s.__history) return;
      s.__history = s.__history.filter(x => !(x.k === k && x.i === i && x.qid === qid));
      W_Progress(s)
    }
    
    let settings = S_Settings();
    let currentTab = "subjects";

    // START: SOUND ENGINE
    const Sound = {
        _fadeInterval: null,
        
        getCurrentMusicElement: () => {
            return $(`#sound-background-${settings.backgroundMusicTrack}`);
        },

        fadeVolume: (audioElement, targetVolume, duration = 1000) => {
            clearInterval(Sound._fadeInterval);
            const startVolume = audioElement.volume;
            const volumeChange = targetVolume - startVolume;
            if (volumeChange === 0) return;

            const steps = 50;
            const stepDuration = duration / steps;
            let currentStep = 0;

            Sound._fadeInterval = setInterval(() => {
                currentStep++;
                const progress = currentStep / steps;
                audioElement.volume = startVolume + (volumeChange * progress);

                if (currentStep >= steps) {
                    audioElement.volume = targetVolume;
                    clearInterval(Sound._fadeInterval);
                }
            }, stepDuration);
        },

        play: (id, volume = 1.0) => {
            if (!settings.soundEffects && !id.includes('background')) return;
            const soundElement = document.getElementById(id);
            if (soundElement) {
                soundElement.volume = Math.max(0, Math.min(volume, 1));
                if(id === 'sound-incorrect') {
                    soundElement.volume = Math.max(0, Math.min(volume, 2));
                }
                soundElement.currentTime = 0;
                soundElement.play().catch(e => {});
            }
        },
        playBackgroundMusic: () => {
            if (!settings.backgroundMusic) return;
            const bgMusic = Sound.getCurrentMusicElement();
            if (bgMusic && bgMusic.paused) {
                bgMusic.volume = settings.backgroundMusicVolume;
                bgMusic.play().catch(e => {});
            }
        },
        stopAllBackgroundMusic: () => {
            $$('audio[id^="sound-background-"]').forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
        },
        toggleMute: () => {
            const bgMusic = Sound.getCurrentMusicElement();
            if (!bgMusic) return;
            settings.musicMuted = !settings.musicMuted;
            $$('audio[id^="sound-background-"]').forEach(audio => audio.muted = settings.musicMuted);
            W_Settings(settings);
            updateMusicToggleButton();
        },
        switchTrack: (newTrack) => {
            Sound.stopAllBackgroundMusic();
            settings.backgroundMusicTrack = newTrack;
            W_Settings(settings);
            Sound.playBackgroundMusic();
        },
        duckBackgroundMusic: (duration = 400) => {
            const bgMusic = Sound.getCurrentMusicElement();
            if (bgMusic && !bgMusic.paused && !bgMusic.muted) {
                Sound.fadeVolume(bgMusic, 0.1, duration);
            }
        },
        unduckBackgroundMusic: () => {
            const bgMusic = Sound.getCurrentMusicElement();
             if (bgMusic && !bgMusic.paused && !bgMusic.muted) {
                Sound.fadeVolume(bgMusic, settings.backgroundMusicVolume, 1500);
            }
        },
        playCorrect: () => Sound.play('sound-correct', settings.correctVolume),
        playIncorrect: () => Sound.play('sound-incorrect', settings.incorrectVolume),
        playNavigate: () => Sound.play('sound-navigate', settings.navigateVolume),
        playFinishGood: () => Sound.play('sound-finish-good', settings.finishGoodVolume),
        playFinishBad: () => Sound.play('sound-finish-bad', settings.finishBadVolume),
    };
    // END: SOUND ENGINE

    /* ---------- Data ---------- */
    const SUBJECTS = [{
      code: "BIOPY4",
      type: "subtopics",
    }, {
      code: "IMM201",
      type: "plain",
    }, {
      code: "MBG301",
      type: "plain",
    }, ];
    const SUBTOPICS = {
      "BIOPY4": [{
        name: "Cell Structure & Function",
      }, {
        name: "Microbial Growth & Control",
      }, {
        name: "Genetics & Molecular Biology",
      }, ]
    };

    /* ---------- Question Pools (≥25 each) ---------- */
    const POOL = {
      /* BIOPY4 subtopic 1 */
      "BIOPY4::Cell Structure & Function": [{
        id: "c_01",
        type: "mcq",
        q: "Primary stain in Gram staining:",
        options: ["Crystal violet", "Safranin", "Carbol fuchsin", "Methylene blue"],
        answer: 0
      }, {
        id: "c_02",
        type: "mcq",
        q: "Gram-negative hallmark:",
        options: ["Thick PG no OM", "Thin PG + outer membrane", "No PG", "Teichoic acids only"],
        answer: 1
      }, {
        id: "c_03",
        type: "subjective",
        q: "Describe the function of the bacterial cell wall and mention its primary component.",
        answer: "The primary function of the bacterial cell wall is to provide structural support, maintain the cell's shape, and protect it from osmotic lysis. The main component is peptidoglycan (also known as murein)."
      }, {
        id: "c_04",
        type: "mcq",
        q: "Bacterial ribosome:",
        options: ["50S+40S", "60S+40S", "50S+30S", "70S+50S"],
        answer: 2
      }, {
        id: "c_05",
        type: "mcq",
        q: "Capsule is best seen by:",
        options: ["India ink (negative)", "Ziehl–Neelsen", "Endospore stain", "Giemsa"],
        answer: 0
      }, {
        id: "c_06",
        type: "mcq",
        q: "Flagella all around cell:",
        options: ["Monotrichous", "Lophotrichous", "Amphitrichous", "Peritrichous"],
        answer: 3
      }, {
        id: "c_07",
        type: "mcq",
        q: "Peptidoglycan crosslinks inhibited by:",
        options: ["Tetracycline", "Vancomycin", "Polymyxin B", "Rifampicin"],
        answer: 1
      }, {
        id: "c_08",
        type: "mcq",
        q: "Teichoic acids present in:",
        options: ["Gram-positive wall", "Gram-negative OM", "Periplasm only", "Archaea"],
        answer: 0
      }, {
        id: "c_09",
        type: "mcq",
        q: "ETC in bacteria is located on:",
        options: ["Cell membrane", "Periplasm", "Cytosol", "Outer membrane"],
        answer: 0
      }, {
        id: "c_10",
        type: "mcq",
        q: "Endospore core contains:",
        options: ["Chitin", "Dipicolinic acid", "Lignin", "Cellulose"],
        answer: 1
      }, {
        id: "c_11",
        type: "mcq",
        q: "Acid-fast cell wall contains:",
        options: ["Sterols", "Mycolic acids", "Chitin", "Ergosterol"],
        answer: 1
      }, {
        id: "c_12",
        type: "mcq",
        q: "Periplasm is found in:",
        options: ["Gram-positive", "Gram-negative", "Mycoplasma", "Fungi"],
        answer: 1
      }, {
        id: "c_13",
        type: "mcq",
        q: "Fimbriae mainly mediate:",
        options: ["Motility", "Adherence", "Secretion", "Conjugation"],
        answer: 1
      }, {
        id: "c_14",
        type: "mcq",
        q: "S-layer is composed of:",
        options: ["Protein/glycoprotein", "Polysaccharide", "Lipid", "DNA"],
        answer: 0
      }, {
        id: "c_15",
        type: "mcq",
        q: "Typical bacterial genome:",
        options: ["Linear diploid", "Circular haploid", "Linear haploid", "Circular diploid"],
        answer: 1
      }, {
        id: "c_16",
        type: "mcq",
        q: "PHB inclusions store:",
        options: ["Nitrogen", "Sulfur", "Carbon/energy", "Iron"],
        answer: 2
      }, {
        id: "c_17",
        type: "mcq",
        q: "MreB is associated with:",
        options: ["Rod shape", "Replication", "Secretion", "Motility"],
        answer: 0
      }, {
        id: "c_18",
        type: "mcq",
        q: "Glycocalyx functions:",
        options: ["Protein synthesis", "Adherence & protection", "ATP generation", "DNA repair"],
        answer: 1
      }, {
        id: "c_19",
        type: "mcq",
        q: "L-form bacteria lack:",
        options: ["Ribosomes", "DNA", "Cell wall", "Membrane"],
        answer: 2
      }, {
        id: "c_20",
        type: "mcq",
        q: "Microscopy for 3D surface:",
        options: ["Bright-field", "Phase-contrast", "SEM", "TEM"],
        answer: 2
      }, {
        id: "c_21",
        type: "mcq",
        q: "Quellung reaction detects:",
        options: ["Capsule swelling", "Spore coat", "Flagella", "Teichoic acids"],
        answer: 0
      }, {
        id: "c_22",
        type: "mcq",
        q: "Porins are in:",
        options: ["Gram+ wall", "Gram− outer membrane", "Cytoplasmic membrane", "S-layer only"],
        answer: 1
      }, {
        id: "c_23",
        type: "mcq",
        q: "LPS toxic component:",
        options: ["Lipid A", "Core polysaccharide", "O-antigen", "Teichoic acid"],
        answer: 0
      }, {
        id: "c_24",
        type: "mcq",
        q: "Mycoplasma membranes contain:",
        options: ["Ergosterol", "Cholesterol", "Mycolic acids", "LTA"],
        answer: 1
      }, {
        id: "c_25",
        type: "mcq",
        q: "Pili used for:",
        options: ["Conjugation/adherence", "Chemotaxis", "Sporulation", "Phototaxis"],
        answer: 0
      }],
      /* BIOPY4 subtopic 2 */
      "BIOPY4::Microbial Growth & Control": [{
        id: "g_01",
        q: "Mesophile optimum:",
        options: ["0–15°C", "15–45°C", "45–80°C", ">80°C"],
        answer: 1
      }, {
        id: "g_02",
        q: "Thermoduric means:",
        options: ["Grow at high T only", "Survive high T briefly", "Psychrophile", "Barophile"],
        answer: 1
      }, {
        id: "g_03",
        q: "Autoclave standard:",
        options: ["100°C 15 min", "121°C 15 min @15 psi", "160°C 1 h", "134°C 1 min"],
        answer: 1
      }, {
        id: "g_04",
        q: "Filtration is best for:",
        options: ["Heat-sensitive fluids", "Glassware", "Metal tools", "Dry powders"],
        answer: 0
      }, {
        id: "g_05",
        q: "Microaerophile prefers:",
        options: ["0% O₂", "Low O₂", "Normal air", "High CO₂ only"],
        answer: 1
      }, {
        id: "g_06",
        q: "Quorum sensing role:",
        options: ["DNA replication", "Cell–cell communication", "Protein folding", "Glycolysis"],
        answer: 1
      }, {
        id: "g_07",
        q: "Batch phases:",
        options: ["Lag, log, stationary, death", "Lag only", "Log only", "Stationary only"],
        answer: 0
      }, {
        id: "g_08",
        q: "CFU counts measure:",
        options: ["Total cells", "Viable cells", "Dead cells", "Spores only"],
        answer: 1
      }, {
        id: "g_09",
        q: "MacConkey is:",
        options: ["Selective + differential", "Enriched only", "Selective only", "Differential only"],
        answer: 0
      }, {
        id: "g_10",
        q: "D-value is:",
        options: ["1-log kill time", "MIC", "MBC", "TDP"],
        answer: 0
      }, {
        id: "g_11",
        q: "Phenolics action:",
        options: ["DNA crosslink", "Membrane disruption", "PG synthesis block", "Protein synthesis"],
        answer: 1
      }, {
        id: "g_12",
        q: "Alcohol best at:",
        options: ["<40%", "60–90%", "100%", "Any"],
        answer: 1
      }, {
        id: "g_13",
        q: "VBNC means:",
        options: ["Viable non-culturable", "Very big non-cell", "Viral burden non-count", "Variable bacillary count"],
        answer: 0
      }, {
        id: "g_14",
        q: "Halotolerant grows in:",
        options: ["Acid", "Salt", "Cold", "Pressure"],
        answer: 1
      }, {
        id: "g_15",
        q: "Chemostat maintains:",
        options: ["Batch culture", "Steady-state continuous culture", "Anaerobiosis", "Quiescence"],
        answer: 1
      }, {
        id: "g_16",
        q: "PMF drives:",
        options: ["DNA ligation", "ATP synthesis", "Transcription", "Splicing"],
        answer: 1
      }, {
        id: "g_17",
        q: "Decimal reduction time:",
        options: ["Time for 90% kill", "Half-life", "Tmax", "Tmin"],
        answer: 0
      }, {
        id: "g_18",
        q: "Sporicidal level:",
        options: ["Low-level disinfectant", "High-level/sterilant", "Antiseptic only", "Soap"],
        answer: 1
      }, {
        id: "g_19",
        q: "Psychrotroph grows at:",
        options: ["0–7°C", "25–30°C", "50–60°C", ">80°C"],
        answer: 0
      }, {
        id: "g_20",
        q: "Bacteriostatic agent:",
        options: ["Kills cells", "Inhibits growth", "Removes water", "Oxidizes lipids"],
        answer: 1
      }, {
        id: "g_21",
        q: "TDP is:",
        options: ["Thermal death point", "Turbidity decimal point", "Total dilution point", "Threshold density point"],
        answer: 0
      }, {
        id: "g_22",
        q: "HEPA used for:",
        options: ["Liquid sterilization", "Air filtration", "Metal sterilization", "Dry heat"],
        answer: 1
      }, {
        id: "g_23",
        q: "Iodophors are:",
        options: ["Phenolics", "Halogens", "Alcohols", "QACs"],
        answer: 1
      }, {
        id: "g_24",
        q: "MIC definition:",
        options: ["Lowest conc. preventing visible growth", "Highest bactericidal conc.", "Median serum level", "Peak level"],
        answer: 0
      }, {
        id: "g_25",
        q: "MBC definition:",
        options: ["Lowest bactericidal conc.", "Lowest inhibitory conc.", "Most buffered conc.", "Minimum biofilm conc."],
        answer: 0
      }],
      /* BIOPY4 subtopic 3 */
      "BIOPY4::Genetics & Molecular Biology": [{
        id: "m_01",
        q: "Transfer via phage:",
        options: ["Transformation", "Conjugation", "Transduction", "Transposition"],
        answer: 2
      }, {
        id: "m_02",
        q: "Hfr strains have:",
        options: ["Integrated F factor", "Free F plasmid", "No F genes", "Deleted oriT"],
        answer: 0
      }, {
        id: "m_03",
        q: "lacZ encodes:",
        options: ["β-galactosidase", "Permease", "Transacetylase", "Repressor"],
        answer: 0
      }, {
        id: "m_04",
        q: "DNA gyrase targeted by:",
        options: ["β-lactams", "Quinolones", "Macrolides", "Polymyxins"],
        answer: 1
      }, {
        id: "m_05",
        q: "Rho-independent termination:",
        options: ["Hairpin + poly-U", "Rho helicase", "RNase H", "RNAP pause only"],
        answer: 0
      }, {
        id: "m_06",
        q: "CRISPR provides:",
        options: ["Motility", "Adaptive anti-phage immunity", "Protein export", "Metabolism"],
        answer: 1
      }, {
        id: "m_07",
        q: "Attenuation senses:",
        options: ["tRNA charging", "pH", "NaCl", "Light"],
        answer: 0
      }, {
        id: "m_08",
        q: "Transposase function:",
        options: ["Cuts/pastes mobile DNA", "Ligates Okazaki", "Methylates DNA", "Degrades RNA"],
        answer: 0
      }, {
        id: "m_09",
        q: "oriT needed for:",
        options: ["Chromosome replication", "Conjugative transfer", "Transcription", "Translation"],
        answer: 1
      }, {
        id: "m_10",
        q: "σ factor does:",
        options: ["Promoter recognition", "Ribosome assembly", "Splicing", "Polyadenylation"],
        answer: 0
      }, {
        id: "m_11",
        q: "Blue-white screening uses:",
        options: ["lacZ α-complementation", "GFP", "Antibiograms", "qPCR Ct"],
        answer: 0
      }, {
        id: "m_12",
        q: "SOS regulators:",
        options: ["LexA & RecA", "AraC & CRP", "LacI & CAP", "Rho & NusA"],
        answer: 0
      }, {
        id: "m_13",
        q: "Two-component system:",
        options: ["Sensor kinase/response regulator", "Ligase/helicase", "σ/core RNAP", "ABC/porin"],
        answer: 0
      }, {
        id: "m_14",
        q: "Riboswitches respond to:",
        options: ["Metabolites binding RNA", "Proteases", "Phosphatases", "Lipids"],
        answer: 0
      }, {
        id: "m_15",
        q: "Integrons capture cassettes via:",
        options: ["Integrase", "Topoisomerase I", "RNase E", "Ligase"],
        answer: 0
      }, {
        id: "m_16",
        q: "Electroporation increases:",
        options: ["DNA uptake", "ATP yield", "Peptide bond", "Capsule"],
        answer: 1
      }, {
        id: "m_17",
        q: "PCR denaturation:",
        options: ["~55°C", "~72°C", "~94–98°C", "~37°C"],
        answer: 2
      }, {
        id: "m_18",
        q: "Lambda lysogeny keeps:",
        options: ["cI repressor active", "Cro dominant", "No repression", "CRP active"],
        answer: 0
      }, {
        id: "m_19",
        q: "Chi sites stimulate:",
        options: ["RecBCD recombination", "Mismatch repair", "BER", "NHEJ"],
        answer: 0
      }, {
        id: "m_20",
        q: "Shine–Dalgarno binds:",
        options: ["23S rRNA", "16S rRNA", "5S rRNA", "tRNAi^Met"],
        answer: 1
      }, {
        id: "m_21",
        q: "Operon is:",
        options: ["Group of genes under single promoter", "Single gene only", "Promoterless cassette", "Noncoding RNA only"],
        answer: 0
      }, {
        id: "m_22",
        q: "Lac operon induced by:",
        options: ["Glucose", "Lactose/allolactose", "Galactose", "Sucrose"],
        answer: 1
      }, {
        id: "m_23",
        q: "CAP–cAMP activates under:",
        options: ["High glucose", "Low glucose", "High lactose", "High cAMP & glucose"],
        answer: 1
      }, {
        id: "m_24",
        q: "RecA key role:",
        options: ["Recombination & SOS", "DNA ligation", "Helicase", "Transcription"],
        answer: 0
      }, {
        id: "m_25",
        q: "Ames test detects:",
        options: ["Mutagens via reversion", "Antibiotics", "Toxins via LD50", "Phage titer"],
        answer: 0
      }],
      /* IMM201 (plain) */
      "IMM201": [{
        id: "i_01",
        q: "PRRs detect:",
        options: ["Self antigens", "PAMPs/MAMPs", "Antibodies", "Cytokines"],
        answer: 1
      }, {
        id: "i_02",
        q: "Opsonization enhances:",
        options: ["Transcription", "Phagocytosis", "Sporulation", "Conjugation"],
        answer: 1
      }, {
        id: "i_03",
        q: "Classical complement triggered by:",
        options: ["MBL", "C3 tickover", "Ag–Ab complexes", "LPS"],
        answer: 2
      }, {
        id: "i_04",
        q: "Main APC for naïve T cells:",
        options: ["Neutrophil", "Dendritic cell", "Eosinophil", "Basophil"],
        answer: 1
      }, {
        id: "i_05",
        q: "TLR4 recognizes:",
        options: ["Flagellin", "CpG DNA", "dsRNA", "LPS"],
        answer: 3
      }, {
        id: "i_06",
        q: "Neutralizing antibodies block:",
        options: ["Host cytokines", "Pathogen entry/toxins", "Complement", "MHC I"],
        answer: 1
      }, {
        id: "i_07",
        q: "Major opsonins:",
        options: ["C5b & Factor B", "C3b & IgG", "IgE & IL-4", "TNF-α & IL-1"],
        answer: 1
      }, {
        id: "i_08",
        q: "Th1 cytokines:",
        options: ["IL-4, IL-5", "IL-17", "IFN-γ, IL-2", "TGF-β"],
        answer: 2
      }, {
        id: "i_09",
        q: "MHC I presents:",
        options: ["Extracellular", "Cytosolic peptides", "Lysosomal", "Carbohydrates"],
        answer: 1
      }, {
        id: "i_10",
        q: "Cytotoxic without prior sensitization:",
        options: ["B cell", "NK cell", "Eosinophil", "Mast cell"],
        answer: 1
      }, {
        id: "i_11",
        q: "Affinity maturation site:",
        options: ["Thymus", "Bone marrow", "Germinal centers", "Red pulp"],
        answer: 2
      }, {
        id: "i_12",
        q: "Mucosal Ig:",
        options: ["IgA", "IgG", "IgM", "IgE"],
        answer: 0
      }, {
        id: "i_13",
        q: "Superantigens activate T cells by:",
        options: ["Bind TCR Vβ & MHC outside groove", "↑ uptake", "Stabilize pMHC", "Block BCR"],
        answer: 0
      }, {
        id: "i_14",
        q: "Type I IFNs:",
        options: ["Neutrophil degranulation", "Antiviral state", "Eosinophils", "↑ IgE"],
        answer: 1
      }, {
        id: "i_15",
        q: "Somatic hypermutation in:",
        options: ["Pre-B", "GC B cells", "Thymocytes", "NK cells"],
        answer: 1
      }, {
        id: "i_16",
        q: "MAC is:",
        options: ["C1–C3", "C3bBb", "C5b–C9", "C2aC4b"],
        answer: 2
      }, {
        id: "i_17",
        q: "ADCC mainly via:",
        options: ["Neutrophils", "NK cells (FcγRIII)", "Basophils", "DCs"],
        answer: 1
      }, {
        id: "i_18",
        q: "T cell central tolerance site:",
        options: ["Bone marrow", "Spleen", "Thymus", "Nodes"],
        answer: 2
      }, {
        id: "i_19",
        q: "IL-17 producer:",
        options: ["Th1", "Th2", "Th17", "Tfh"],
        answer: 2
      }, {
        id: "i_20",
        q: "Class switching requires:",
        options: ["RAG1/2", "AID + T cell help", "Ku70/80", "TdT"],
        answer: 1
      }, {
        id: "i_21",
        q: "DAMPs are:",
        options: ["Microbial", "Host danger signals", "Plant", "Food allergens"],
        answer: 1
      }, {
        id: "i_22",
        q: "Bridges innate↔adaptive:",
        options: ["Neutrophil", "Dendritic cell", "Basophil", "Erythrocyte"],
        answer: 1
      }, {
        id: "i_23",
        q: "Eosinophil growth cytokine:",
        options: ["IL-2", "IL-5", "IFN-γ", "IL-12"],
        answer: 1
      }, {
        id: "i_24",
        q: "Treg TF:",
        options: ["T-bet", "GATA3", "RORγt", "Foxp3"],
        answer: 3
      }, {
        id: "i_25",
        q: "Best correlate for neutralizing vaccines:",
        options: ["T cell index", "Serum neutralizing titer", "CRP", "ESR"],
        answer: 1
      }],
      /* MBG301 (plain) */
      "MBG301": [{
        id: "gk_01",
        q: "Restriction enzymes cut:",
        options: ["Proteins", "RNA", "Specific DNA sequences", "Lipids"],
        answer: 2
      }, {
        id: "gk_02",
        q: "Plasmids replicate via:",
        options: ["oriV", "Telomeres", "Centromeres", "Kinetochore"],
        answer: 0
      }, {
        id: "gk_03",
        q: "Blue-white uses:",
        options: ["lacZ α-comp.", "GFP", "Antibiogram", "qPCR"],
        answer: 0
      }, {
        id: "gk_04",
        q: "PCR denaturation:",
        options: ["~55°C", "~72°C", "~94–98°C", "~37°C"],
        answer: 2
      }, {
        id: "gk_05",
        q: "Ligase forms:",
        options: ["Hydrogen bonds", "Phosphodiester bonds", "Peptide bonds", "Ionic bonds"],
        answer: 1
      }, {
        id: "gk_06",
        q: "Electroporation increases:",
        options: ["Membrane rigidity", "DNA uptake", "ATP", "Ribosomes"],
        answer: 1
      }, {
        id: "gk_07",
        q: "Rolling-circle replication:",
        options: ["Some plasmids & phages", "Mitochondria", "Only chromosomes", "Fungi"],
        answer: 0
      }, {
        id: "gk_08",
        q: "IS elements are:",
        options: ["Integrative plasmids", "Simple transposons", "Phage tails", "Riboswitches"],
        answer: 1
      }, {
        id: "gk_09",
        q: "SOS response regulators:",
        options: ["LexA/RecA", "LacI/CAP", "AraC/CRP", "IHF only"],
        answer: 0
      }, {
        id: "gk_10",
        q: "CRISPR array is:",
        options: ["Exons/introns", "Repeats & spacers", "Promoters/operators", "UTRs"],
        answer: 1
      }, {
        id: "gk_11",
        q: "Conjugation pilus from:",
        options: ["Phage genome", "F plasmid tra genes", "rRNA loci", "IS10"],
        answer: 1
      }, {
        id: "gk_12",
        q: "Replica plating selects:",
        options: ["Auxotrophs", "MIC", "Viruses", "Endotoxin"],
        answer: 0
      }, {
        id: "gk_13",
        q: "Two-component system:",
        options: ["Sensor kinase & response regulator", "Ligase/helicase", "σ/core", "ABC/porin"],
        answer: 0
      }, {
        id: "gk_14",
        q: "Riboswitch regulation by:",
        options: ["Metabolite-binding RNA", "Protein operators", "sRNA degradation", "DNA methylation"],
        answer: 0
      }, {
        id: "gk_15",
        q: "Chi sites stimulate:",
        options: ["RecBCD recombination", "Mismatch repair", "BER", "NHEJ"],
        answer: 0
      }, {
        id: "gk_16",
        q: "Attenuation senses:",
        options: ["tRNA charging", "Membrane potential", "ATP:ADP", "pH"],
        answer: 0
      }, {
        id: "gk_17",
        q: "Integrons use:",
        options: ["Integrase", "Topo I", "Pol I", "RNase H"],
        answer: 0
      }, {
        id: "gk_18",
        q: "Plasmid incompatibility relates to:",
        options: ["Origin control systems", "Antibiotic selection", "GC content", "RBS"],
        answer: 0
      }, {
        id: "gk_19",
        q: "OriT is for:",
        options: ["Conjugation", "Chromosome replication", "Termination", "Translation"],
        answer: 0
      }, {
        id: "gk_20",
        q: "σ factor function:",
        options: ["Promoter recognition", "Splicing", "Poly-A", "Ribosome assembly"],
        answer: 0
      }, {
        id: "gk_21",
        q: "Generalized transduction by:",
        options: ["Temperate only", "Lytic phage mispackaging", "Conjugation", "Transformation"],
        answer: 1
      }, {
        id: "gk_22",
        q: "Specialized transduction by:",
        options: ["Lytic phage", "Lysogenic phage excision", "Transformation", "Transposition"],
        answer: 1
      }, {
        id: "gk_23",
        q: "Natural competence:",
        options: ["DNA uptake from environment", "Swarming", "Biofilm", "Secretion"],
        answer: 0
      }, {
        id: "gk_24",
        q: "Rho-independent termination:",
        options: ["Hairpin + poly-U", "Rho helicase", "RNase E", "Shine–Dalgarno"],
        answer: 0
      }, {
        id: "gk_25",
        q: "LacI is:",
        options: ["Repressor", "Activator", "Sigma factor", "Helicase"],
        answer: 0
      }]
    };

    /* ---------- Icons & crumbs ---------- */
    function DocIcon() {
      const s = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      s.setAttribute("viewBox", "0 0 24 24");
      s.classList.add("icon");
      s.innerHTML = '<path d="M14 2H7a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8z" fill="currentColor" opacity=".18"/><path d="M14 2v6h6" fill="currentColor" opacity=".6"/>';
      return s
    }
    const strong = t => {
      const e = document.createElement("strong");
      e.textContent = t;
      e.style.color = "var(--ink-100)";
      return e
    }
    const crumb = (t, fn) => {
      const b = document.createElement("button");
      b.className = "crumb";
      b.onclick = () => {
        Sound.playNavigate();
        fn();
      };
      b.textContent = t;
      return b
    }
    const active = (t) => {
      const b = document.createElement("button");
      b.className = "crumb active";
      b.textContent = t;
      b.disabled = true;
      return b
    }
    const sep = () => {
      const s = document.createElement("span");
      s.className = "sep";
      s.textContent = "›";
      return s
    }

    /* ---------- Elements ---------- */
    const headerContainer = $(".header-container");
    const subjectsView = $("#subjectsView");
    const progressView = $("#progressView");
    const historyView = $("#historyView");
    const qbankView = $("#qbankView");
    const customQuizView = $("#customQuizView");
    const tutorialsView = $("#tutorialsView");
    const settingsView = $("#settingsView");
    const quizPanel = $("#quizPanel");

    /* ---------- Tabs ---------- */
    $("#tabs").addEventListener("click", e => {
      Sound.playNavigate();
      const btn = e.target.closest(".tab[data-tab]");
      if (!btn) return;
      $$(".tab[data-tab]").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentTab = btn.dataset.tab;

      const views = [subjectsView, progressView, historyView, qbankView, customQuizView, tutorialsView, settingsView, quizPanel];
      views.forEach(v => hide(v));

      if (currentTab === "subjects") {
        show(subjectsView);
        renderSubjects();
      } else if (currentTab === "progress") {
        show(progressView);
        renderProgress();
      } else if (currentTab === "history") {
        show(historyView);
        renderHistory();
      } else if (currentTab === "qbank") {
        show(qbankView);
        renderQuestionBank();
      } else if (currentTab === "customQuiz") {
        show(customQuizView);
        renderCustomQuiz();
      } else if (currentTab === "tutorials") {
        show(tutorialsView);
        renderTutorials();
      } else if (currentTab === "settings") {
        show(settingsView);
        renderSettings();
      }
    });

    $("#resetAll").onclick = () => {
      Sound.playNavigate();
      localStorage.removeItem(PROGRESS_KEY);
      toast("All progress cleared");
      if (currentTab === "progress") renderProgress();
      else if (currentTab === "subjects") renderSubjects();
      else if (currentTab === "history") renderHistory();
      else if (currentTab === "qbank") renderQuestionBank();
    };

    function show(el) {
      if(el) el.classList.remove("hidden");
    }

    function hide(el) {
      if(el) el.classList.add("hidden");
    }

    /* ---------- Subjects ---------- */
    function renderSubjects() {
      subjectsView.innerHTML = "";

      if(settings.randomizeAll) {
          const btn = document.createElement("button");
          btn.className = "btn primary";
          btn.textContent = "🚀 Start Fully Randomized Quiz";
          btn.style.width = "100%";
          btn.style.padding = "20px";
          btn.style.fontSize = "1.2rem";
          btn.onclick = () => {
              const allQuestions = Object.values(POOL).flat();
              const questionSelection = shuffleArray(allQuestions).slice(0, settings.defaultRandomQuestions);
              renderQuiz('Full Random', '1', settings.defaultRandomQuestions, questionSelection);
          };
          subjectsView.append(btn);
          subjectsView.append(document.createElement("hr"));
      }


      const list = document.createElement("div");
      list.className = "list";
      SUBJECTS.forEach(s => {
        const row = document.createElement("button");
        row.className = "row";
        const L = document.createElement("div");
        L.className = "left";
        L.append(DocIcon(), strong(s.code));
        const R = document.createElement("div");
        R.className = "right";
        R.textContent = "›";
        row.append(L, R);
        row.onclick = () => {
            Sound.playNavigate();
            s.type === "subtopics" ? renderSubtopics(s) : renderSetsPlain(s);
        }
        list.append(row);
      });
      subjectsView.append(list);
    }

    function renderSubtopics(subject) {
      subjectsView.innerHTML = "";
      const bc = document.createElement("div");
      bc.className = "crumbs";
      bc.append(crumb("🏠 All subjects", renderSubjects), sep(), active(subject.code));
      subjectsView.append(bc);

      const list = document.createElement("div");
      list.className = "list";
      (SUBTOPICS[subject.code] || []).forEach(su => {
        const row = document.createElement("button");
        row.className = "row";
        const L = document.createElement("div");
        L.className = "left";
        L.append(DocIcon(), strong(su.name));
        const R = document.createElement("div");
        R.className = "right";
        R.textContent = "›";
        row.append(L, R);
        row.onclick = () => {
            Sound.playNavigate();
            renderSetsSub(subject, su);
        }
        list.append(row);
      });
      subjectsView.append(list);
    }
    
    function makeSetRow(key, i, renderFn) {
      const row = document.createElement("button");
      row.className = "row";
      const L = document.createElement("div");
      L.className = "left";
      L.append(DocIcon(), strong(`set ${i}`));
      const R = document.createElement("div");
      R.className = "right right-flex";
      const st = getSet(key, i);
      const badge = document.createElement("span");
      if (st) {
        badge.className = "pill ok";
        badge.textContent = `⭐ ${st.score}/${st.total}`;
      } else {
        badge.className = "pill warn";
        badge.textContent = "🔵 pending";
      }
      const restart = document.createElement("button");
      restart.className = "mini ghost";
      restart.textContent = "↻";
      restart.onclick = (e) => {
        Sound.playNavigate();
        e.stopPropagation();
        resetSet(key, i);
        toast(`Set ${i} reset`);
        renderFn(); // Re-render the current view
      };
      R.append(badge, restart);
      row.onclick = () => {
          Sound.playNavigate();
          renderQuiz(key, i, settings.defaultSetQuestions);
      };
      row.append(L, R);
      return row;
    }

    function renderSetsSub(subject, sub) {
      subjectsView.innerHTML = "";
      const bc = document.createElement("div");
      bc.className = "crumbs";
      bc.append(crumb("🏠 All subjects", renderSubjects), sep(), crumb(subject.code, () => renderSubtopics(subject)), sep(), active(sub.name));
      subjectsView.append(bc);

      const list = document.createElement("div");
      list.className = "list";
      const totalSets = Math.ceil(POOL[`${subject.code}::${sub.name}`].length / settings.defaultSetQuestions);
      for (let i = 1; i <= totalSets; i++) {
        const key = `${subject.code}::${sub.name}`;
        list.append(makeSetRow(key, i, () => renderSetsSub(subject, sub)));
      }
      subjectsView.append(list);
    }

    function renderSetsPlain(subject) {
      subjectsView.innerHTML = "";
      const bc = document.createElement("div");
      bc.className = "crumbs";
      bc.append(crumb("🏠 All subjects", renderSubjects), sep(), active(subject.code));
      subjectsView.append(bc);

      const list = document.createElement("div");
      list.className = "list";
      const totalSets = Math.ceil(POOL[subject.code].length / settings.defaultSetQuestions);
      for (let i = 1; i <= totalSets; i++) {
        const key = subject.code;
        list.append(makeSetRow(key, i, () => renderSetsPlain(subject)));
      }
      subjectsView.append(list);
    }

    /* ---------- Quiz ---------- */
    let ctx = null; // {key,index,perSet,chosen,i,score,answered}
    
    function renderQuiz(key, setIndex, perSet, customQuestions = null) {
        let questionSelection;

        if (customQuestions) {
            questionSelection = customQuestions;
        } else {
            let pool = (POOL[key] || []).slice();
            
            if (settings.excludeSeenQuestions) {
                const progress = S_Progress();
                const seenIds = new Set(Object.keys(progress.__seen || {}));
                const unseenPool = pool.filter(q => !seenIds.has(q.id));

                if (unseenPool.length > 0) {
                    pool = unseenPool;
                } else {
                    toast("All questions in this topic have been seen!");
                }
            }

            if (settings.randomizeSetSelection) {
                const shuffledPool = shuffleArray(pool);
                questionSelection = shuffledPool.slice(0, perSet);
            } else {
                const start = (setIndex - 1) * perSet;
                questionSelection = pool.slice(start, start + perSet);
            }
        }
        
        const progress = S_Progress();
        progress.__seen = progress.__seen || {};
        questionSelection.forEach(q => {
            progress.__seen[q.id] = true;
        });
        W_Progress(progress);
        
        let chosen = questionSelection.map(q => {
            if (q.type === 'subjective') {
                return { ...q };
            }
            const correct = q.options[q.answer];
            const displayOptions = settings.shuffleAnswerOrder ? shuffleArray([...q.options]) : [...q.options];
            return {
                ...q,
                type: 'mcq',
                options: displayOptions,
                correct
            };
        });
        
        if (settings.randomizeQuestionOrder) {
            shuffleArray(chosen);
        }

      hide(headerContainer);
      hide(subjectsView);
      hide(progressView);
      hide(historyView);
      hide(qbankView);
      hide(customQuizView);
      hide(tutorialsView);
      hide(settingsView);
      show(quizPanel);

      const bc = $("#crumbs");
      bc.innerHTML = "";
      
      const exitQuiz = (renderFn, ...args) => {
          show(headerContainer);
          hide(quizPanel);
          renderFn(...args);
      };
      
      if (key === 'Custom Quiz' || key === 'Full Random') {
          bc.append(active(key));
      } else if (key.includes("::")) {
        const [scode, sub] = key.split("::");
        const subjectData = SUBJECTS.find(s => s.code === scode);
        const subtopicData = SUBTOPICS[scode].find(s => s.name === sub);
        bc.append(
          crumb("🏠 All subjects", () => exitQuiz(renderSubjects)), sep(),
          crumb(scode, () => exitQuiz(renderSubtopics, subjectData)), sep(),
          crumb(sub, () => exitQuiz(renderSetsSub, subjectData, subtopicData)), sep(),
          active(`set ${setIndex}`)
        );
      } else {
        const subjectData = SUBJECTS.find(s => s.code === key);
        bc.append(
          crumb("🏠 All subjects", () => exitQuiz(renderSubjects)), sep(),
          crumb(key, () => exitQuiz(renderSetsPlain, subjectData)), sep(),
          active(`set ${setIndex}`)
        );
      }

      ctx = { key, index: setIndex, perSet: chosen.length, chosen, i: 0, score: 0, answered: 0 };
      
      $("#btnNext").onclick = () => {
        Sound.playNavigate();
        if (ctx.i < ctx.chosen.length - 1) {
          ctx.i++;
          drawQ()
        }
      };
      $("#btnFinish").onclick = showResults;
      
      drawQ();
    }

    function handleNext() {
        const last = (ctx.i === ctx.chosen.length - 1);
        if (last) {
            hide($('#btnNext'));
            show($('#btnFinish'));
        } else {
            $("#btnNext").disabled = false;
        }
    }

    function drawQ() {
      const q = ctx.chosen[ctx.i];
      $("#qtext").textContent = `Q${ctx.i+1}. ${q.q}`;
      
      ctx.isAnswered = false;
      hide($("#opts"));
      hide($("#subjectivePanel"));
      $("#btnNext").disabled = true;
      hide($('#btnFinish'));
      show($('#btnNext'));

      
      const fill = $("#progFill");
      fill.style.width = Math.round((ctx.i / ctx.chosen.length) * 100) + "%";

      if (q.type === 'subjective') {
        show($("#subjectivePanel"));
        const answerInput = $("#subjectiveAnswerInput");
        const revealedPanel = $("#revealedAnswerPanel");
        const selfAssessPanel = $("#selfAssessPanel");
        const btnReveal = $("#btnReveal");
        const btnSkip = $("#btnSkip");
        const btnCorrect = $("#btnCorrect");
        const btnIncorrect = $("#btnIncorrect");

        answerInput.value = "";
        answerInput.disabled = false;
        btnCorrect.disabled = false;
        btnIncorrect.disabled = false;
        hide(revealedPanel);
        hide(selfAssessPanel);
        show(btnReveal);
        show(btnSkip);

        $("#answerText").textContent = q.answer;

        btnReveal.onclick = () => {
            Sound.playNavigate();
            answerInput.disabled = true;
            show(revealedPanel);
            show(selfAssessPanel);
            hide(btnReveal);
            hide(btnSkip);
        };

        btnSkip.onclick = () => {
            Sound.playIncorrect();
            addWrong(ctx.key, ctx.index, q.id);
            ctx.answered++;
            fill.style.width = Math.round((ctx.answered / ctx.chosen.length) * 100) + "%";
            handleNext();
        };

        const handleSelfAssessment = (isCorrect) => {
            if (ctx.isAnswered) return;
            ctx.isAnswered = true;
            btnCorrect.disabled = true;
            btnIncorrect.disabled = true;

            if (isCorrect) {
                Sound.playCorrect();
                ctx.score++;
                remWrong(ctx.key, ctx.index, q.id);
            } else {
                Sound.playIncorrect();
                addWrong(ctx.key, ctx.index, q.id);
            }
            ctx.answered++;
            fill.style.width = Math.round((ctx.answered / ctx.chosen.length) * 100) + "%";
            handleNext();
        };

        btnCorrect.onclick = () => handleSelfAssessment(true);
        btnIncorrect.onclick = () => handleSelfAssessment(false);

      } else { // MCQ
        show($("#opts"));
        const opts = $("#opts");
        opts.innerHTML = "";
        
        q.options.forEach(opt => {
            const b = document.createElement("button");
            b.className = "opt";
            b.textContent = opt;
            b.onclick = () => {
                if (ctx.isAnswered) return;
                ctx.isAnswered = true;

                $$(".opt", opts).forEach(x => x.disabled = true);
                const ok = (opt === q.correct);
                if (ok) {
                    Sound.playCorrect();
                    b.classList.add("correct");
                    ctx.score++;
                    remWrong(ctx.key, ctx.index, q.id);
                } else {
                    Sound.playIncorrect();
                    b.classList.add("incorrect");
                    addWrong(ctx.key, ctx.index, q.id);
                }

                ctx.answered++;
                fill.style.width = Math.round((ctx.answered / ctx.chosen.length) * 100) + "%";
                handleNext();
            };
            opts.append(b);
        });
      }
    }

    /* ---------- Progress (live) ---------- */
    function renderProgress() {
        progressView.innerHTML = "";
        const st = S_Progress();
        
        let totalPossibleSets = 0;
        const displayList = [];
        SUBJECTS.forEach(s => {
            if (s.type === 'plain') {
                totalPossibleSets += Math.ceil(POOL[s.code].length / settings.defaultSetQuestions);
                displayList.push({ code: s.code, key: s.code });
            } else if (s.type === 'subtopics') {
                const subtopics = SUBTOPICS[s.code] || [];
                subtopics.forEach(sub => {
                    totalPossibleSets += Math.ceil(POOL[`${s.code}::${sub.name}`].length / settings.defaultSetQuestions);
                    displayList.push({ 
                        code: `${s.code} - ${sub.name}`, 
                        key: `${s.code}::${sub.name}`
                    });
                });
            }
        });

        let answered = 0, correct = 0, setsDone = 0;
        Object.keys(st).filter(k => !k.startsWith('__')).forEach(subjectKey => {
            Object.values(st[subjectKey]).forEach(v => {
                answered += v.total || 0;
                correct += v.score || 0;
                setsDone++;
            });
        });
        
        const acc = answered ? Math.round(correct / answered * 100) : 0;

        const stats = document.createElement("div");
        stats.className = "stats";
        stats.innerHTML = `
            <div class="stat-card"><div class="stat-k">Total answered</div><div class="stat-v">${answered}</div></div>
            <div class="stat-card"><div class="stat-k">Accuracy</div><div class="stat-v">${acc}%</div></div>
            <div class="stat-card"><div class="stat-k">Sets completed</div><div class="stat-v">${setsDone}/${totalPossibleSets}</div></div>`;
        progressView.append(stats);

        const grid = document.createElement("div");
        grid.className = "subject-grid";

        displayList.forEach(item => {
            const card = document.createElement("div");
            card.className = "subject-card";
            const head = document.createElement("div");
            head.className = "sub-head";
            
            const done = Object.keys(S_Progress()[item.key] || {}).length;
            const totalSets = Math.ceil(POOL[item.key].length / settings.defaultSetQuestions);
            head.innerHTML = `<div class="sub-title">${item.code}</div><div class="sub-meta">${done}/${totalSets} sets</div>`;
            card.append(head);

            const meter = document.createElement("div");
            meter.className = "meter";
            const mf = document.createElement("div");
            mf.className = "meter-fill";
            mf.style.width = (done / totalSets * 100) + "%";
            meter.append(mf);
            card.append(meter);

            const chips = document.createElement("div");
            chips.className = "chips";
            for (let i = 1; i <= totalSets; i++) {
                const state = getSet(item.key, i);
                const chip = document.createElement("button");
                chip.className = "chip " + (state ? "chip-ok" : "chip-warn");
                const emoji = document.createElement("span");
                const label = document.createElement("span");
                
                if (state) {
                    emoji.textContent = "⭐";
                    label.textContent = `set ${i} (${state.score}/${state.total})`;
                } else {
                    emoji.textContent = "🔵";
                    label.textContent = `set ${i}`;
                }

                const reset = document.createElement("button");
                reset.className = "reset";
                reset.textContent = "↻";
                reset.title = "Reset this set";
                reset.onclick = (e) => {
                    e.stopPropagation();
                    Sound.playNavigate();
                    resetSet(item.key, i);
                    toast(`Reset ${item.code} set ${i}`);
                    renderProgress();
                };

                chip.append(emoji, label, reset);
                chip.onclick = () => {
                    Sound.playNavigate();
                    renderQuiz(item.key, i, settings.defaultSetQuestions);
                }

                chips.append(chip);
            }
            card.append(chips);
            grid.append(card);
        });
        progressView.append(grid);
    }

    /* ---------- Settings ---------- */
    function renderSettings() {
        settingsView.innerHTML = `
            <div class="setting-group">
                <div class="setting-group-header" data-group="general">
                    <div>
                        <div class="title">General Settings</div>
                        <div class="desc">Appearance and startup options.</div>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="setting-group-content">
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Show Tribute Animation</div>
                            <div class="desc">Play animation on app load.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="showTributeToggle" ${settings.showTribute ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-group-header" data-group="randomizer">
                    <div>
                        <div class="title">Randomization</div>
                        <div class="desc">Control how questions and answers are shuffled.</div>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="setting-group-content">
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Default Set Questions</div>
                            <div class="desc">Number of questions per set. (Min: 5)</div>
                        </div>
                        <div class="setting-control">
                            <input type="number" id="defaultSetQuestionsInput" value="${settings.defaultSetQuestions}" min="5" style="width: 80px; padding: 8px; border-radius: 8px; border: 1px solid var(--line); background: var(--tile2); color: var(--ink-100);">
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Default Random Questions</div>
                            <div class="desc">Number of questions for "Randomize All". (Min: 10)</div>
                        </div>
                        <div class="setting-control">
                            <input type="number" id="defaultRandomQuestionsInput" value="${settings.defaultRandomQuestions}" min="10" style="width: 80px; padding: 8px; border-radius: 8px; border: 1px solid var(--line); background: var(--tile2); color: var(--ink-100);">
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Randomize All Subjects & Sets</div>
                            <div class="desc">Adds a quick-start button to the Subjects page.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="randomizeAllToggle" ${settings.randomizeAll ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Exclude Seen Questions</div>
                            <div class="desc">Don't repeat questions you've already answered.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="excludeSeenToggle" ${settings.excludeSeenQuestions ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Randomize Question Selection</div>
                            <div class="desc">Pull questions randomly from the available pool.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="randomizeSetSelectionToggle" ${settings.randomizeSetSelection ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Randomize Question Order</div>
                            <div class="desc">Shuffle question order within a set.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="randomizeQuestionOrderToggle" ${settings.randomizeQuestionOrder ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Shuffle Answer Order</div>
                            <div class="desc">Shuffle multiple-choice answer order.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="shuffleAnswerOrderToggle" ${settings.shuffleAnswerOrder ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-group-header" data-group="audio">
                    <div>
                        <div class="title">Audio Settings</div>
                        <div class="desc">Manage sound effects and music.</div>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="setting-group-content">
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Sound Effects</div>
                            <div class="desc">Enable UI sound effects.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundEffectsToggle" ${settings.soundEffects ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Background Music</div>
                            <div class="desc">Enable background music.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="backgroundMusicToggle" ${settings.backgroundMusic ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                     <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Music Track</div>
                            <div class="desc">Choose your study vibe.</div>
                        </div>
                        <div class="setting-control" id="musicTrackControl">
                           <button class="mini ${settings.backgroundMusicTrack === 'chill' ? 'active' : ''}" data-track="chill">Chill</button>
                           <button class="mini ${settings.backgroundMusicTrack === 'hype' ? 'active' : ''}" data-track="hype">Hype</button>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Music Volume</div>
                        </div>
                        <div class="setting-control">
                            <input type="range" id="backgroundMusicVolumeSlider" min="0" max="1" step="0.05" value="${settings.backgroundMusicVolume}">
                            <span id="backgroundMusicVolumeLabel">${Math.round(settings.backgroundMusicVolume * 100)}%</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Navigation Volume</div>
                        </div>
                        <div class="setting-control">
                            <input type="range" id="navigateVolumeSlider" min="0" max="1" step="0.05" value="${settings.navigateVolume}">
                            <span id="navigateVolumeLabel">${Math.round(settings.navigateVolume * 100)}%</span>
                        </div>
                    </div>
                     <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Correct Answer Volume</div>
                        </div>
                        <div class="setting-control">
                            <input type="range" id="correctVolumeSlider" min="0" max="1" step="0.05" value="${settings.correctVolume}">
                            <span id="correctVolumeLabel">${Math.round(settings.correctVolume * 100)}%</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Incorrect Answer Volume</div>
                        </div>
                        <div class="setting-control">
                            <input type="range" id="incorrectVolumeSlider" min="0" max="2" step="0.05" value="${settings.incorrectVolume}">
                            <span id="incorrectVolumeLabel">${Math.round(settings.incorrectVolume * 100)}%</span>
                        </div>
                    </div>
                     <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">High Score Finish Volume</div>
                        </div>
                        <div class="setting-control">
                            <input type="range" id="finishGoodVolumeSlider" min="0" max="1" step="0.05" value="${settings.finishGoodVolume}">
                            <span id="finishGoodVolumeLabel">${Math.round(settings.finishGoodVolume * 100)}%</span>
                        </div>
                    </div>
                     <div class="setting-row">
                        <div class="setting-text">
                            <div class="title">Low Score Finish Volume</div>
                        </div>
                        <div class="setting-control">
                            <input type="range" id="finishBadVolumeSlider" min="0" max="1" step="0.05" value="${settings.finishBadVolume}">
                            <span id="finishBadVolumeLabel">${Math.round(settings.finishBadVolume * 100)}%</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Accordion logic
        $$('.setting-group-header').forEach(header => {
            header.addEventListener('click', () => {
                Sound.playNavigate();
                const content = header.nextElementSibling;
                header.classList.toggle('open');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });

        // Event Listeners for Toggles
        $("#showTributeToggle").addEventListener('change', e => { settings.showTribute = e.target.checked; W_Settings(settings); });
        $("#randomizeAllToggle").addEventListener('change', e => { settings.randomizeAll = e.target.checked; W_Settings(settings); });
        $("#excludeSeenToggle").addEventListener('change', e => { settings.excludeSeenQuestions = e.target.checked; W_Settings(settings); });
        $("#randomizeSetSelectionToggle").addEventListener('change', e => { settings.randomizeSetSelection = e.target.checked; W_Settings(settings); });
        $("#randomizeQuestionOrderToggle").addEventListener('change', e => { settings.randomizeQuestionOrder = e.target.checked; W_Settings(settings); });
        $("#shuffleAnswerOrderToggle").addEventListener('change', e => { settings.shuffleAnswerOrder = e.target.checked; W_Settings(settings); });
        $("#soundEffectsToggle").addEventListener('change', e => { settings.soundEffects = e.target.checked; W_Settings(settings); });
        
        $("#backgroundMusicToggle").addEventListener('change', e => {
            settings.backgroundMusic = e.target.checked;
            W_Settings(settings);
            if (settings.backgroundMusic) Sound.playBackgroundMusic();
            else Sound.stopAllBackgroundMusic();
            updateMusicToggleButton();
        });
        
        // Music Track Selection
        $('#musicTrackControl').addEventListener('click', e => {
            const btn = e.target.closest('.mini');
            if(!btn) return;
            $$('.mini', e.currentTarget).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            Sound.switchTrack(btn.dataset.track);
        });

        // Event Listeners for Number Inputs
        $("#defaultSetQuestionsInput").addEventListener('change', e => {
            let val = parseInt(e.target.value, 10);
            if (isNaN(val) || val < 5) {
                val = 5;
                e.target.value = val;
                toast("Minimum questions per set is 5.");
            }
            settings.defaultSetQuestions = val;
            W_Settings(settings);
            toast("Default set length saved.");
        });
        $("#defaultRandomQuestionsInput").addEventListener('change', e => {
            let val = parseInt(e.target.value, 10);
            if (isNaN(val) || val < 10) {
                val = 10;
                e.target.value = val;
                toast("Minimum questions for random quiz is 10.");
            }
            settings.defaultRandomQuestions = val;
            W_Settings(settings);
            toast("Default random quiz length saved.");
        });

        // Helper for volume sliders
        const setupVolumeSlider = (sliderId, labelId, settingKey, soundPreviewFn) => {
            const slider = $(`#${sliderId}`);
            const label = $(`#${labelId}`);
            slider.addEventListener('input', e => {
                const newVolume = parseFloat(e.target.value);
                settings[settingKey] = newVolume;
                label.textContent = `${Math.round(newVolume * 100)}%`;
                if (settingKey === 'backgroundMusicVolume') {
                    const bgMusic = Sound.getCurrentMusicElement();
                    if (bgMusic) bgMusic.volume = newVolume;
                }
            });
            slider.addEventListener('change', () => {
                W_Settings(settings);
                if (soundPreviewFn) soundPreviewFn();
            });
        };

        // Setup all volume sliders
        setupVolumeSlider('backgroundMusicVolumeSlider', 'backgroundMusicVolumeLabel', 'backgroundMusicVolume');
        setupVolumeSlider('navigateVolumeSlider', 'navigateVolumeLabel', 'navigateVolume', Sound.playNavigate);
        setupVolumeSlider('correctVolumeSlider', 'correctVolumeLabel', 'correctVolume', Sound.playCorrect);
        setupVolumeSlider('incorrectVolumeSlider', 'incorrectVolumeLabel', 'incorrectVolume', Sound.playIncorrect);
        setupVolumeSlider('finishGoodVolumeSlider', 'finishGoodVolumeLabel', 'finishGoodVolume', Sound.playFinishGood);
        setupVolumeSlider('finishBadVolumeSlider', 'finishBadVolumeLabel', 'finishBadVolume', Sound.playFinishBad);
    }

    /* ---------- Wrong History (Practice Mode) ---------- */
    let practiceList = [], practiceIdx = 0;

    function renderHistory() {
        historyView.innerHTML = "";
        const st = S_Progress(),
            hist = (st.__history || []).slice(-120).reverse();

        const actions = document.createElement("div");
        actions.className = "history-actions";
        const clear = document.createElement("button");
        clear.className = "mini ghost";
        clear.textContent = "Clear history";
        clear.onclick = () => {
            Sound.playNavigate();
            const s = S_Progress();
            s.__history = [];
            W_Progress(s);
            renderHistory()
        };
        actions.append(clear);
        historyView.append(actions);

        if (!hist.length) {
            const empty = document.createElement("div");
            empty.className = "hist-empty";
            empty.textContent = "No wrong answers yet. Keep studying! ✨";
            historyView.append(empty);
            return;
        }

        const list = document.createElement("div");
        list.className = "history-list";

        const groupedHistory = hist.reduce((acc, item) => {
            const groupKey = `${item.k} • set ${item.i}`;
            if(!acc[groupKey]) acc[groupKey] = [];
            acc[groupKey].push(item);
            return acc;
        }, {});

        Object.entries(groupedHistory).forEach(([groupKey, items]) => {
            const group = document.createElement('div');
            group.className = 'setting-group';
            
            const header = document.createElement('div');
            header.className = 'setting-group-header';
            header.innerHTML = `
                <div>
                    <div class="title">${groupKey}</div>
                </div>
                <div class="chevron">›</div>
            `;
            group.append(header);

            const content = document.createElement('div');
            content.className = 'setting-group-content';
            
            const innerList = document.createElement('div');
            innerList.className = 'history-list';
            innerList.style.padding = '16px';

            items.forEach((item, idx) => {
                const q = (POOL[item.k] || []).find(x => x.id === item.qid);
                if (!q) return;

                const row = document.createElement("div");
                row.className = "hist-row";

                const qCell = document.createElement("div");
                qCell.className = "hist-q-cell";
                qCell.textContent = q.q;

                const actionCell = document.createElement("div");
                actionCell.className = "hist-action-cell";
                const btn = document.createElement("button");
                btn.className = "mini";
                btn.textContent = "📝 Practice";
                btn.onclick = () => {
                    Sound.playNavigate();
                    startPractice(hist.indexOf(item));
                };
                actionCell.append(btn);

                row.append(qCell, actionCell);
                innerList.append(row);
            });
            
            content.append(innerList);
            group.append(content);
            list.append(group);
        });

        historyView.append(list);

        // Accordion logic for history
        $$('.setting-group-header', historyView).forEach(header => {
            header.addEventListener('click', () => {
                Sound.playNavigate();
                const content = header.nextElementSibling;
                header.classList.toggle('open');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });
    }

    function startPractice(startIndex) {
      const st = S_Progress();
      practiceList = (st.__history || []).slice(-120).reverse();
      if (!practiceList.length) {
        renderHistory();
        return;
      }
      practiceIdx = Math.max(0, Math.min(startIndex, practiceList.length - 1));
      $("#modal").classList.remove("hidden");
      drawPractice();
    }

    function drawPractice() {
      const st = S_Progress();
      practiceList = (st.__history || []).slice(-120).reverse();

      if (!practiceList.length) {
        $("#modal").classList.add("hidden");
        renderHistory();
        toast("All corrected — history is clear");
        return;
      }

      practiceIdx = Math.max(0, Math.min(practiceIdx, practiceList.length - 1));
      const it = practiceList[practiceIdx];
      const pool = POOL[it.k] || [];
      const q = pool.find(x => x.id === it.qid);

      if (!q) {
        remWrong(it.k, it.i, it.qid);
        drawPractice();
        return;
      }
      
      const [subject, subtopic] = it.k.split('::');
      $("#revMeta").textContent = subtopic ? `${subject} - ${subtopic} • set ${it.i}` : `${subject} • set ${it.i}`;
      $("#revQ").textContent = q.q;
      const ans = $("#revAns");
      ans.innerHTML = "";

      const correctText = q.type === 'subjective' ? q.answer : q.options[q.answer];
      
      if(q.type === 'subjective') {
        ans.innerHTML = `<div class="answer-text" style="color: var(--ink-100)">${q.answer}</div>`;
      } else {
        const opts = shuffleArray(q.options.slice());
        opts.forEach(optText => {
            const b = document.createElement("button");
            b.className = "opt";
            b.textContent = optText;
            b.onclick = () => {
                if (optText === correctText) {
                    Sound.playCorrect();
                    b.classList.add("correct");
                    remWrong(it.k, it.i, it.qid);
                    setTimeout(() => {
                        const s2 = S_Progress();
                        practiceList = (s2.__history || []).slice(-120).reverse();
                        if (!practiceList.length) {
                            $("#modal").classList.add("hidden");
                            renderHistory();
                            toast("Removed from Wrong History");
                            return;
                        }
                        practiceIdx = Math.min(practiceIdx, practiceList.length - 1);
                        drawPractice();
                        renderHistory();
                    }, 550);
                } else {
                    Sound.playIncorrect();
                    b.classList.add("incorrect");
                    b.disabled = true;
                }
            };
            ans.appendChild(b);
        });
      }

      $("#histPrev").onclick = () => {
        Sound.playNavigate();
        practiceIdx = (practiceIdx - 1 + practiceList.length) % practiceList.length;
        drawPractice();
      };
      $("#histNext").onclick = () => {
        Sound.playNavigate();
        practiceIdx = (practiceIdx + 1) % practiceList.length;
        drawPractice();
      };
      $("#openHistory").onclick = () => {
        Sound.playNavigate();
        $("#modal").classList.add("hidden");
        renderHistory();
      };
      $("#closeModal").onclick = () => {
        Sound.playNavigate();
        $("#modal").classList.add("hidden");
      };
    }

    /* ---------- Question Bank ---------- */
    function renderQuestionBank() {
        qbankView.innerHTML = "";
        const progress = S_Progress();
        const seenIds = new Set(Object.keys(progress.__seen || {}));
        
        const actions = document.createElement("div");
        actions.className = "history-actions";
        const clear = document.createElement("button");
        clear.className = "mini ghost";
        clear.textContent = "Clear Seen History";
        clear.onclick = () => {
            Sound.playNavigate();
            const s = S_Progress();
            s.__seen = {};
            W_Progress(s);
            toast("Seen question history cleared.");
            renderQuestionBank();
        };
        actions.append(clear);
        qbankView.append(actions);
        
        Object.entries(POOL).forEach(([key, questions]) => {
            const [subject, subtopic] = key.split('::');
            const group = document.createElement('div');
            group.className = 'setting-group'; // Reuse style
            
            const header = document.createElement('div');
            header.className = 'setting-group-header';
            header.innerHTML = `
                <div>
                    <div class="title">${subtopic ? `${subject} - ${subtopic}` : subject}</div>
                </div>
                <div class="chevron">›</div>
            `;
            group.append(header);

            const content = document.createElement('div');
            content.className = 'setting-group-content';
            
            const list = document.createElement('div');
            list.className = 'history-list';
            list.style.padding = '16px';

            questions.forEach(q => {
                const row = document.createElement("div");
                row.className = "hist-row";
                const seen = seenIds.has(q.id);
                 if (seen) {
                    row.style.opacity = "0.6";
                }

                const qCell = document.createElement("div");
                qCell.className = "hist-q-cell";
                qCell.textContent = q.q;

                const statusCell = document.createElement("div");
                statusCell.className = "hist-action-cell";
                statusCell.textContent = seen ? "✅ Seen" : "❔ Unseen";
                statusCell.style.color = seen ? 'var(--ok)' : 'var(--warn)';
                
                row.append(qCell, statusCell);
                list.append(row);
            });
            
            content.append(list);
            group.append(content);
            qbankView.append(group);
        });

        // Accordion logic for question bank
        $$('.setting-group-header', qbankView).forEach(header => {
            header.addEventListener('click', () => {
                Sound.playNavigate();
                const content = header.nextElementSibling;
                header.classList.toggle('open');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });
    }
    
    /* ---------- Custom Quiz ---------- */
    function renderCustomQuiz() {
        customQuizView.innerHTML = "";
        const intro = document.createElement('p');
        intro.textContent = "Select any combination of sets from any subject to create your own custom quiz.";
        intro.style.textAlign = 'center';
        intro.style.marginBottom = '20px';
        customQuizView.append(intro);

        const selectionGrid = document.createElement('div');
        selectionGrid.className = 'subject-grid'; // Reuse style
        selectionGrid.style.gap = '16px';

        Object.entries(POOL).forEach(([key, questions]) => {
            const [subject, subtopic] = key.split('::');
            const group = document.createElement('div');
            group.className = 'subject-card';
            
            const head = document.createElement('div');
            head.className = 'sub-head';
            head.innerHTML = `<div class="sub-title">${subtopic ? `${subject} - ${subtopic}` : subject}</div>`;
            group.append(head);

            const setChips = document.createElement('div');
            setChips.className = 'chips';
            
            const sets = {};
            const setSize = settings.defaultSetQuestions;
            questions.forEach((q, index) => {
                const setNum = Math.floor(index / setSize) + 1;
                if(!sets[setNum]) sets[setNum] = [];
                sets[setNum].push(q);
            });

            Object.keys(sets).forEach(setNum => {
                const label = document.createElement('label');
                label.className = 'chip';
                label.style.cursor = 'pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.key = key;
                checkbox.dataset.set = setNum;
                checkbox.style.marginRight = '8px';
                label.append(checkbox, `Set ${setNum}`);
                setChips.append(label);
            });

            group.append(setChips);
            selectionGrid.append(group);
        });

        customQuizView.append(selectionGrid);

        const controls = document.createElement('div');
        controls.style.marginTop = '24px';
        controls.style.display = 'flex';
        controls.style.justifyContent = 'center';
        controls.style.alignItems = 'center';
        controls.style.gap = '16px';
        controls.style.flexWrap = 'wrap';

        const inputLabel = document.createElement('label');
        inputLabel.textContent = 'Number of questions:';
        inputLabel.style.fontWeight = '700';
        
        const numberInput = document.createElement('input');
        numberInput.type = 'number';
        numberInput.id = 'customQuizCount';
        numberInput.value = 10;
        numberInput.min = 1;
        numberInput.style.width = '80px';
        numberInput.style.padding = '8px';
        numberInput.style.borderRadius = '8px';
        numberInput.style.border = '1px solid var(--line)';
        numberInput.style.background = 'var(--tile2)';
        numberInput.style.color = 'var(--ink-100)';
        numberInput.style.fontFamily = 'inherit';
        
        const startBtn = document.createElement('button');
        startBtn.className = 'btn primary';
        startBtn.textContent = 'Start Custom Quiz';

        // Logic to update max questions
        selectionGrid.addEventListener('change', () => {
            const selectedSets = $$('input[type="checkbox"]:checked', customQuizView);
            let questionCount = 0;
            selectedSets.forEach(checkbox => {
                const key = checkbox.dataset.key;
                const setNum = parseInt(checkbox.dataset.set, 10);
                const start = (setNum - 1) * settings.defaultSetQuestions;
                const setQuestions = POOL[key].slice(start, start + settings.defaultSetQuestions);
                questionCount += setQuestions.length;
            });
            numberInput.max = questionCount > 0 ? questionCount : 1;
            if (parseInt(numberInput.value) > questionCount) {
                numberInput.value = questionCount;
            }
        });


        startBtn.onclick = () => {
            const selectedSets = $$('input[type="checkbox"]:checked', customQuizView);
            if(selectedSets.length === 0) {
                toast("Please select at least one set.");
                return;
            }

            let customPool = [];
            selectedSets.forEach(checkbox => {
                const key = checkbox.dataset.key;
                const setNum = parseInt(checkbox.dataset.set, 10);
                const start = (setNum - 1) * settings.defaultSetQuestions;
                const setQuestions = POOL[key].slice(start, start + settings.defaultSetQuestions);
                customPool.push(...setQuestions);
            });

            const numQuestions = parseInt(numberInput.value, 10);
            if (isNaN(numQuestions) || numQuestions < 1) {
                toast("Please enter a valid number of questions.");
                return;
            }
            if (numQuestions > customPool.length) {
                toast(`You can only set a limit of ${customPool.length} questions.`);
                numberInput.value = customPool.length;
                return;
            }

            const finalQuestions = shuffleArray(customPool).slice(0, numQuestions);
            renderQuiz('Custom Quiz', 1, finalQuestions.length, finalQuestions);
        };

        controls.append(inputLabel, numberInput, startBtn);
        customQuizView.append(controls);
    }

    /* ---------- Tutorials ---------- */
    function renderTutorials() {
        tutorialsView.innerHTML = `
            <div class="setting-group">
                <div class="setting-group-header open" data-group="custom-quiz">
                    <div>
                        <div class="title">🔀 In-Depth Guide: Custom Quiz</div>
                        <div class="desc">Create the perfect study session tailored to your needs.</div>
                    </div>
                    <div class="chevron" style="transform: rotate(90deg);">›</div>
                </div>
                <div class="setting-group-content" style="max-height: 500px;">
                    <div style="padding: 16px; line-height: 1.6;">
                        <p>The <strong>Custom Quiz</strong> tab is your most powerful tool for targeted studying. It allows you to break free from the pre-defined subjects and focus precisely on what you need to learn.</p>
                        <h4>How It Works:</h4>
                        <ol style="margin-left: 20px;">
                            <li><strong>Select Your Sets:</strong> Browse through all the subjects and subtopics. Click the checkboxes next to any set you want to include. You can mix and match from different subjects to create a comprehensive review. For example, select "Set 1" from <em>Genetics</em> and "Set 3" from <em>Immunology</em>.</li>
                            <li><strong>Choose the Length:</strong> After selecting your sets, the total number of available questions is calculated. You can then enter the exact number of questions you want in your quiz in the input box. This is great for quick 10-question reviews or longer 50-question practice exams.</li>
                            <li><strong>Start Quiz:</strong> Click the "Start Custom Quiz" button. The app will pull your chosen number of questions randomly from all the sets you selected and begin your personalized session.</li>
                        </ol>
                        <h4>Pro-Tips for Effective Studying:</h4>
                        <p>
                           - <strong>Target Weak Areas:</strong> After a few standard quizzes, check the "Progress" tab. If you see you're struggling with a specific topic, come here and build a custom quiz using only sets from that topic.
                           <br>- <strong>Spaced Repetition:</strong> Create a small quiz of 10-15 questions from topics you studied last week to reinforce your memory.
                           <br>- <strong>Exam Simulation:</strong> Combine sets from all subjects to simulate a final exam, helping you practice switching between different concepts.
                        </p>
                    </div>
                </div>
            </div>
             <div class="setting-group">
                <div class="setting-group-header" data-group="history-practice">
                    <div>
                        <div class="title">⌛ Mastering the History & Practice Mode</div>
                        <div class="desc">Turn your mistakes into your greatest strengths.</div>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="setting-group-content">
                    <div style="padding: 16px; line-height: 1.6;">
                        <p>Every question you get wrong is automatically added to the <strong>History</strong> tab. This isn't a list of failures; it's a personalized list of opportunities to learn.</p>
                        <h4>How to Use It:</h4>
                        <p>
                           - <strong>Review Your Errors:</strong> Go to the "History" tab to see a list of all the questions you've answered incorrectly, grouped by the quiz you took.
                           <br>- <strong>Practice Mode:</strong> Click the "Practice" button next to any question. This opens a special review modal where you can try the question again without the pressure of a real quiz.
                           <br>- <strong>Instant Correction:</strong> If you get it right in practice mode, it's instantly removed from your history. This ensures your history list always reflects what you still need to work on.
                           <br>- <strong>Clear History:</strong> Once you feel confident, you can clear your entire history and start fresh.
                        </p>
                    </div>
                </div>
            </div>
             <div class="setting-group">
                <div class="setting-group-header" data-group="q-bank">
                    <div>
                        <div class="title">🏦 Understanding the Question Bank</div>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="setting-group-content">
                    <div style="padding: 16px; line-height: 1.6;">
                        <p>The Question Bank shows you every single question available in the app. It helps you track your overall coverage of the material.</p>
                        <ul>
                            <li><strong>✅ Seen:</strong> This question has appeared in at least one of your quizzes.</li>
                            <li><strong>❔ Unseen:</strong> You have not yet encountered this question.</li>
                        </ul>
                        <p>Use the "Clear Seen History" button to reset the status of all questions back to "Unseen". This is useful if you want to start tracking your progress from scratch. Combine this with the "Exclude Seen Questions" setting for a powerful way to ensure you see every question at least once.</p>
                    </div>
                </div>
            </div>
             <div class="setting-group">
                <div class="setting-group-header" data-group="random-settings">
                    <div>
                        <div class="title">⚙️ Mastering the Randomization Settings</div>
                    </div>
                    <div class="chevron">›</div>
                </div>
                <div class="setting-group-content">
                    <div style="padding: 16px; line-height: 1.6;">
                        <h4>Simple Explanation</h4>
                        <p>These toggles change how quizzes are created. You can make sets pull random questions, shuffle the order, and even hide questions you've already seen to focus on new material.</p>
                        <hr style="border-color: var(--line); margin: 16px 0;">
                        <h4>In-Depth Scenarios</h4>
                        <p>Here’s how the settings interact:</p>
                        <ul>
                            <li><strong>Scenario 1: Standard Study</strong><br>
                                <code>Randomize Question Selection</code> is OFF.<br>
                                <strong>Outcome:</strong> "Set 1" will always contain the first 5 questions from the topic's list. This is predictable and good for structured learning.
                            </li>
                            <br>
                            <li><strong>Scenario 2: Focused Review</strong><br>
                                <code>Randomize Question Selection</code> is ON.<br>
                                <code>Exclude Seen Questions</code> is ON.<br>
                                <strong>Outcome:</strong> Each time you start a quiz, it will pull random questions *that you haven't seen before* from that topic. This is the best way to ensure you cover all the material.
                            </li>
                            <br>
                             <li><strong>Scenario 3: Mixed Practice</strong><br>
                                <code>Randomize Question Selection</code> is ON.<br>
                                <code>Exclude Seen Questions</code> is OFF.<br>
                                <strong>Outcome:</strong> Quizzes will be a random mix of all questions from the topic, including ones you've already answered. This is great for reinforcing what you've learned.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        `;

        // Accordion logic for tutorials
        $$('.setting-group-header', tutorialsView).forEach(header => {
            header.addEventListener('click', () => {
                Sound.playNavigate();
                const content = header.nextElementSibling;
                const wasOpen = header.classList.contains('open');
                
                // Close all others
                $$('.setting-group-header', tutorialsView).forEach(h => {
                    h.classList.remove('open');
                    h.nextElementSibling.style.maxHeight = null;
                     h.querySelector('.chevron').style.transform = 'rotate(0deg)';
                });

                if (!wasOpen) {
                    header.classList.add('open');
                    content.style.maxHeight = content.scrollHeight + "px";
                    header.querySelector('.chevron').style.transform = 'rotate(90deg)';
                }
            });
        });
    }
    
    function updateMusicToggleButton() {
        const btn = $("#toggleMusicBtn");
        if (!btn) return;
        const icon = !settings.musicMuted ? 
            `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>` :
            `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`;
        btn.innerHTML = icon;
    }

    /* ---------- Results Screen ---------- */
    function showResults() {
        hide(quizPanel);
        const scoreRatio = ctx.score / ctx.chosen.length;
        let result;

        if (scoreRatio >= 0.8) {
            result = {
                emoji: '🏆',
                title: 'Stellar Performance!',
                message: 'You\'ve mastered this topic. Your knowledge is shining bright!',
                sound: 'sound-finish-good'
            };
        } else if (scoreRatio >= 0.5) {
             result = {
                emoji: '👍',
                title: 'Solid Effort!',
                message: 'A great foundation is built. Keep refining those tricky concepts!',
                sound: 'sound-finish-good'
            };
        } else {
             result = {
                emoji: '🌱',
                title: 'Keep Growing!',
                message: 'Every challenge is a chance to learn. Review your answers and try again!',
                sound: 'sound-finish-bad'
            };
        }

        $("#resultsEmoji").textContent = result.emoji;
        $("#resultsTitle").textContent = result.title;
        $("#resultsScore").textContent = `You scored ${ctx.score} out of ${ctx.chosen.length}`;
        $("#resultsMessage").textContent = result.message;

        if(ctx.key !== 'Custom Quiz' && ctx.key !== 'Full Random') {
            putSet(ctx.key, ctx.index, {
              score: ctx.score,
              total: ctx.chosen.length,
              ts: Date.now()
            });
        }
        
        Sound.duckBackgroundMusic(400); // Faster fade out
        Sound.play(result.sound, settings[result.sound === 'sound-finish-good' ? 'finishGoodVolume' : 'finishBadVolume']);
        
        const resultsScreen = $("#resultsScreen");
        show(resultsScreen);

        resultsScreen.onclick = () => {
            Sound.playNavigate();
            resultsScreen.classList.add('splash-fade-out');
            setTimeout(() => {
                hide(resultsScreen);
                resultsScreen.classList.remove('splash-fade-out');
                show(headerContainer);
                $(`.tab[data-tab="${currentTab}"]`).click();
                Sound.unduckBackgroundMusic();
            }, 500);
        };
    }

    /* ---------- Boot ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        const splash = $("#splashScreen");
        if (settings.showTribute) {
            setTimeout(() => {
                splash.classList.add("splash-fade-out");
                setTimeout(() => {
                    splash.remove();
                    $('.shell').classList.add('loaded');
                }, 1000);
            }, 2800); 
        } else {
            splash.remove();
            $('.shell').classList.add('loaded');
        }
        
        renderSubjects();
        
        const toggleMusicBtn = $("#toggleMusicBtn");
        updateMusicToggleButton();
        toggleMusicBtn.onclick = () => {
            Sound.playNavigate();
            Sound.toggleMute();
        };

        document.body.addEventListener('click', () => {
            if (settings.backgroundMusic) {
                Sound.playBackgroundMusic();
            }
        }, { once: true });
    });
  </script>
</body>

</html>
